<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Showcase - WuwaAPI</title>
    <meta name="description"
        content="A live demo showcasing the capabilities of WuwaAPI - Wuthering Waves character data.">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; base-uri 'self'; form-action 'none'; frame-ancestors 'none'; img-src 'self' https://wuwa-api.projektcode.com data:; style-src 'self'; script-src 'self' 'unsafe-inline'; connect-src https://wuwa-api.projektcode.com">
    <link rel="icon" href="https://wuwa-api.projektcode.com/v1/images/characters/jinhsi/icon.webp" type="image/webp" />
    <link rel="stylesheet" href="../css/base.css?v=2.0">
    <link rel="stylesheet" href="../css/showcase.css?v=2.0">
</head>

<body>
    <nav class="navbar">
        <div class="container nav-inner">
            <a href="../" class="logo">Wuwa<span>API</span></a>
            <div class="nav-links">
                <a href="../docs/">Documentation</a>
                <a href="./" class="active">Showcase</a>
                <a href="https://wuwa-api.projektcode.com/docs" target="_blank" rel="noopener noreferrer">Swagger</a>
                <a href="https://github.com/ProjektCode/wuwa-api" target="_blank" rel="noopener noreferrer">GitHub</a>
            </div>
        </div>
    </nav>

    <main>
        <!-- Loading State -->
        <div id="loadingState" class="loading-state">
            <div class="loading-spinner"></div>
            <p>Loading character data...</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="error-state" style="display: none;">
            <h2>Connection Failed</h2>
            <p id="errorMessage">Unable to fetch data from the API.</p>
            <button type="button" id="retryBtn" class="btn-primary">Retry</button>
        </div>

        <!-- Character Display -->
        <div id="characterDisplay" class="character-display" style="display: none;">
            <!-- Hero Section -->
            <section class="hero-section">
                <div class="hero-bg" id="heroBg"></div>
                <div class="hero-content container">
                    <div class="char-header">
                        <img id="attrIcon" class="attr-icon" alt="Element" />
                        <div class="char-info">
                            <h1 id="charName">Character Name</h1>
                            <div class="char-meta">
                                <span id="charRarity" class="rarity">★★★★★</span>
                                <span id="charElement" class="element-badge">Element</span>
                                <span id="charWeapon" class="weapon-badge">Weapon</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Content Tabs -->
            <div class="container">
                <div class="tabs-container">
                    <nav class="tab-nav">
                        <button type="button" class="tab-btn active" data-tab="overview">Overview</button>
                        <button type="button" class="tab-btn" data-tab="skills">Skills</button>
                        <button type="button" class="tab-btn" data-tab="stats">Stats</button>
                    </nav>

                    <!-- Overview Tab -->
                    <div class="tab-content active" id="tab-overview">
                        <div class="overview-grid">
                            <div class="card">
                                <h3>Character Images</h3>
                                <div id="imageGallery" class="image-gallery"></div>
                            </div>
                            <div class="card">
                                <h3>API Information</h3>
                                <div class="api-info">
                                    <div class="info-row">
                                        <span class="label">Character ID</span>
                                        <code id="charId">-</code>
                                    </div>
                                    <div class="info-row">
                                        <span class="label">Last Updated</span>
                                        <span id="lastUpdated">-</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="label">Data Source</span>
                                        <a id="sourceLink" href="#" target="_blank" rel="noopener noreferrer">View
                                            Source</a>
                                    </div>
                                </div>
                                <div class="endpoint-demo">
                                    <p class="endpoint-label">Try this endpoint:</p>
                                    <code id="endpointUrl" class="endpoint-code">GET /v1/characters/:id</code>
                                    <button type="button" id="copyEndpoint" class="btn-small">Copy</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Skills Tab -->
                    <div class="tab-content" id="tab-skills">
                        <div id="skillsList" class="skills-list"></div>
                    </div>

                    <!-- Stats Tab -->
                    <div class="tab-content" id="tab-stats">
                        <div class="stats-card">
                            <h3>Character Stats by Level</h3>
                            <div id="statsTable" class="stats-table-wrap"></div>
                        </div>
                    </div>
                </div>

                <!-- Footer Info -->
                <div class="showcase-footer">
                    <p>Character rotates automatically. Data provided by <a href="https://wuwa-api.projektcode.com"
                            target="_blank">WuwaAPI</a>.</p>
                    <p class="disclaimer">Not affiliated with Kuro Games. Powered by community data.</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container footer-inner">
            <p>&copy; 2026 WuwaAPI. Not affiliated with Kuro Games.</p>
            <div class="footer-links">
                <a href="../docs/">Docs</a>
                <a href="./">Showcase</a>
                <a href="https://wuwa-api.projektcode.com/docs" target="_blank">API</a>
                <a href="https://github.com/ProjektCode/wuwa-api" target="_blank">GitHub</a>
            </div>
        </div>
    </footer>

    <script>
        const API_BASE = "https://wuwa-api.projektcode.com";
        const ROTATION_INTERVAL = 45 * 60 * 1000; // 45 minutes
        const STORAGE_KEY = "wuwaapi.showcase";

        // DOM Elements
        const loadingState = document.getElementById("loadingState");
        const errorState = document.getElementById("errorState");
        const characterDisplay = document.getElementById("characterDisplay");
        const retryBtn = document.getElementById("retryBtn");

        // Utility Functions
        function escapeHtml(str) {
            if (!str) return "";
            const div = document.createElement("div");
            div.textContent = str;
            return div.innerHTML;
        }

        function resolveUrl(path) {
            if (!path) return "";
            return path.startsWith("http") ? path : `${API_BASE}${path}`;
        }

        // Tab Navigation
        document.querySelectorAll(".tab-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
                document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
                btn.classList.add("active");
                document.getElementById(`tab-${btn.dataset.tab}`).classList.add("active");
            });
        });

        // Character Rotation Logic
        async function getRotationCharacterId() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    if (data.expiresAt > Date.now() && data.characterId) {
                        return data.characterId;
                    }
                } catch (e) { /* ignore */ }
            }

            // Fetch random character
            const res = await fetch(`${API_BASE}/v1/characters?limit=100`);
            if (!res.ok) throw new Error("Failed to fetch character list");
            const json = await res.json();
            const items = json.items || [];
            if (items.length === 0) throw new Error("No characters available");

            const randomChar = items[Math.floor(Math.random() * items.length)];
            const newData = {
                characterId: randomChar.id,
                expiresAt: Date.now() + ROTATION_INTERVAL
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(newData));
            return randomChar.id;
        }

        // Render Functions
        function renderStars(count) {
            return "★".repeat(count);
        }

        function renderSkillCard(skill) {
            const type = skill.type || skill.category || "Skill";
            const desc = skill.descriptionMd || "";
            // Simple markdown: bold and line breaks
            const html = desc
                .replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>")
                .replace(/\n/g, "<br>");

            return `
                <div class="skill-card">
                    <div class="skill-header">
                        <h4>${escapeHtml(skill.name || "Unnamed")}</h4>
                        <span class="skill-type">${escapeHtml(type)}</span>
                    </div>
                    <div class="skill-desc">${html}</div>
                </div>
            `;
        }

        function renderStats(statsByLevel) {
            if (!statsByLevel || Object.keys(statsByLevel).length === 0) {
                return "<p>No stat data available.</p>";
            }

            const levels = Object.keys(statsByLevel).sort((a, b) => Number(a) - Number(b));
            let rows = "";
            for (const lvl of levels) {
                const s = statsByLevel[lvl];
                rows += `
                    <tr>
                        <td>Lv. ${lvl}</td>
                        <td>${s.hp?.toLocaleString() || "-"}</td>
                        <td>${s.atk?.toLocaleString() || "-"}</td>
                        <td>${s.def?.toLocaleString() || "-"}</td>
                    </tr>
                `;
            }

            return `
                <table>
                    <thead>
                        <tr><th>Level</th><th>HP</th><th>ATK</th><th>DEF</th></tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }

        // Main Data Load
        async function loadCharacter() {
            loadingState.style.display = "flex";
            errorState.style.display = "none";
            characterDisplay.style.display = "none";

            try {
                const charId = await getRotationCharacterId();
                const [charRes, imgRes] = await Promise.all([
                    fetch(`${API_BASE}/v1/characters/${charId}`),
                    fetch(`${API_BASE}/v1/characters/${charId}/images`)
                ]);

                if (!charRes.ok) throw new Error(`Character not found: ${charId}`);
                const char = await charRes.json();
                const imgData = imgRes.ok ? await imgRes.json() : { images: [] };

                // Populate Header
                document.getElementById("charName").textContent = char.name || charId;
                document.getElementById("charRarity").textContent = renderStars(char.rarity || 0);
                document.getElementById("charElement").textContent = char.element || "Unknown";
                document.getElementById("charWeapon").textContent = char.weaponType || "Unknown";

                // Attribute Icon
                const attrIcon = document.getElementById("attrIcon");
                if (char.images?.attribute) {
                    attrIcon.src = resolveUrl(char.images.attribute);
                    attrIcon.style.display = "block";
                } else {
                    attrIcon.style.display = "none";
                }

                // Hero Background
                const heroBg = document.getElementById("heroBg");
                if (char.images?.splash) {
                    heroBg.style.backgroundImage = `url(${resolveUrl(char.images.splash)})`;
                }

                // API Info
                document.getElementById("charId").textContent = char.id;
                document.getElementById("lastUpdated").textContent = char.lastUpdated || "-";
                const sourceLink = document.getElementById("sourceLink");
                if (char.source?.prydwen?.url) {
                    sourceLink.href = char.source.prydwen.url;
                    sourceLink.textContent = "Prydwen.gg";
                } else if (char.source?.fandom?.basePage) {
                    sourceLink.href = char.source.fandom.basePage;
                    sourceLink.textContent = "Fandom Wiki";
                } else {
                    sourceLink.style.display = "none";
                }

                document.getElementById("endpointUrl").textContent = `GET /v1/characters/${char.id}`;

                // Image Gallery
                const images = imgData.images || [];
                const gallery = document.getElementById("imageGallery");
                gallery.innerHTML = images.map(img => `
                    <a href="${resolveUrl(img.url)}" target="_blank" class="gallery-thumb">
                        <img src="${resolveUrl(img.url)}" alt="${escapeHtml(img.file)}" loading="lazy" />
                        <span>${escapeHtml(img.file?.replace(".webp", "") || "")}</span>
                    </a>
                `).join("");

                // Skills
                const skills = char.skills || [];
                document.getElementById("skillsList").innerHTML = skills.length > 0
                    ? skills.map(renderSkillCard).join("")
                    : "<p>No skill data available for this character.</p>";

                // Stats
                document.getElementById("statsTable").innerHTML = renderStats(char.statsByLevel);

                // Copy Endpoint
                document.getElementById("copyEndpoint").onclick = async () => {
                    const url = `${API_BASE}/v1/characters/${char.id}`;
                    try {
                        await navigator.clipboard.writeText(url);
                        document.getElementById("copyEndpoint").textContent = "Copied!";
                        setTimeout(() => document.getElementById("copyEndpoint").textContent = "Copy", 1500);
                    } catch (e) { /* ignore */ }
                };

                // Show content
                loadingState.style.display = "none";
                characterDisplay.style.display = "block";

            } catch (err) {
                console.error("Load error:", err);
                loadingState.style.display = "none";
                errorState.style.display = "flex";
                document.getElementById("errorMessage").textContent = err.message || "Unknown error";
            }
        }

        // Retry button
        retryBtn.addEventListener("click", () => {
            localStorage.removeItem(STORAGE_KEY);
            loadCharacter();
        });

        // Init
        loadCharacter();
    </script>
</body>

</html>